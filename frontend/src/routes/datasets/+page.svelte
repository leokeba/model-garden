<script lang="ts">
  import { api } from "$lib/api/client";
  import Badge from "$lib/components/Badge.svelte";
  import Button from "$lib/components/Button.svelte";
  import Card from "$lib/components/Card.svelte";
  import { onMount } from "svelte";

  type Dataset = {
    name: string;
    path: string;
    size: number;
    examples: number;
    format: string;
    created_at: string;
    modified_at?: string;
    metadata?: Record<string, any>;
  };

  type HubDataset = {
    id: string;
    author: string;
    datasetName: string;
    downloads: number;
    likes: number;
    tags: string[];
    description?: string;
    size?: string;
  };

  let datasets: Dataset[] = $state([]);
  let loading = $state(true);
  let error = $state("");
  let uploading = $state(false);
  let uploadProgress = $state(0);

  // Tab state
  let activeTab = $state<"local" | "hub">("local");

  // Upload
  let fileInput: HTMLInputElement | undefined = $state(undefined);
  let selectedFile: File | null = $state(null);
  let datasetName = $state("");
  let datasetType = $state("text");
  let showUploadModal = $state(false);

  // Preview
  let selectedDataset: Dataset | null = $state(null);
  let previewData: any[] = $state([]);
  let loadingPreview = $state(false);

  // Hub browsing
  let hubSearchQuery = $state("");
  let hubFilter = $state<"all" | "text" | "vision" | "audio">("all");
  let selectedHubDataset: HubDataset | null = $state(null);
  let loadingHubDataset = $state(false);

  // Popular datasets from HuggingFace
  const popularDatasets: HubDataset[] = [
    {
      id: "databricks/databricks-dolly-15k",
      author: "databricks",
      datasetName: "databricks-dolly-15k",
      downloads: 850000,
      likes: 1200,
      tags: ["instruction", "text-generation", "english"],
      description: "15k instruction-following examples for fine-tuning LLMs",
      size: "13.4 MB",
    },
    {
      id: "timdettmers/openassistant-guanaco",
      author: "timdettmers",
      datasetName: "openassistant-guanaco",
      downloads: 620000,
      likes: 890,
      tags: ["instruction", "chat", "conversational"],
      description: "Open Assistant conversations optimized for fine-tuning",
      size: "22.1 MB",
    },
    {
      id: "yahma/alpaca-cleaned",
      author: "yahma",
      datasetName: "alpaca-cleaned",
      downloads: 750000,
      likes: 980,
      tags: ["instruction", "text-generation"],
      description: "Cleaned version of the Alpaca instruction dataset",
      size: "44.7 MB",
    },
    {
      id: "HuggingFaceH4/ultrachat_200k",
      author: "HuggingFaceH4",
      datasetName: "ultrachat_200k",
      downloads: 420000,
      likes: 650,
      tags: ["chat", "conversational", "instruction"],
      description: "200k high-quality multi-turn conversations",
      size: "468 MB",
    },
    {
      id: "tatsu-lab/alpaca",
      author: "tatsu-lab",
      datasetName: "alpaca",
      downloads: 950000,
      likes: 1450,
      tags: ["instruction", "text-generation"],
      description: "Stanford Alpaca instruction-following dataset",
      size: "44.2 MB",
    },
    {
      id: "Anthropic/hh-rlhf",
      author: "Anthropic",
      datasetName: "hh-rlhf",
      downloads: 380000,
      likes: 720,
      tags: ["rlhf", "preference", "chat"],
      description: "Human preference data for RLHF",
      size: "286 MB",
    },
    {
      id: "OpenAssistant/oasst1",
      author: "OpenAssistant",
      datasetName: "oasst1",
      downloads: 510000,
      likes: 850,
      tags: ["chat", "instruction", "multilingual"],
      description: "Open Assistant conversation dataset",
      size: "89.4 MB",
    },
    {
      id: "teknium/GPT4-LLM-Cleaned",
      author: "teknium",
      datasetName: "GPT4-LLM-Cleaned",
      downloads: 290000,
      likes: 540,
      tags: ["instruction", "gpt4", "cleaned"],
      description: "GPT-4 generated instruction dataset (cleaned)",
      size: "31.5 MB",
    },
    {
      id: "garage-bAInd/Open-Platypus",
      author: "garage-bAInd",
      datasetName: "Open-Platypus",
      downloads: 180000,
      likes: 420,
      tags: ["instruction", "reasoning", "stem"],
      description: "STEM and logic-focused instruction dataset",
      size: "14.7 MB",
    },
    {
      id: "llamafactory/alpaca_gpt4_en",
      author: "llamafactory",
      datasetName: "alpaca_gpt4_en",
      downloads: 340000,
      likes: 610,
      tags: ["instruction", "gpt4", "english"],
      description: "English instruction dataset generated by GPT-4",
      size: "24.9 MB",
    },
  ];

  let filteredHubDatasets = $derived(
    popularDatasets.filter((dataset) => {
      const matchesSearch =
        hubSearchQuery === "" ||
        dataset.id.toLowerCase().includes(hubSearchQuery.toLowerCase()) ||
        dataset.description
          ?.toLowerCase()
          .includes(hubSearchQuery.toLowerCase());

      const matchesFilter =
        hubFilter === "all" || dataset.tags.includes(hubFilter);

      return matchesSearch && matchesFilter;
    }),
  );

  async function loadDatasets() {
    try {
      loading = true;
      error = "";
      const response = await api.get("/datasets");
      datasets = response.datasets || [];
    } catch (err) {
      error = err instanceof Error ? err.message : "Failed to load datasets";
      datasets = [];
    } finally {
      loading = false;
    }
  }

  function handleFileSelect(event: Event) {
    const target = event.target as HTMLInputElement;
    if (target.files && target.files[0]) {
      selectedFile = target.files[0];
      if (!datasetName) {
        // Auto-fill name from filename
        datasetName = target.files[0].name.replace(/\.[^/.]+$/, "");
      }
    }
  }

  async function uploadDataset() {
    if (!selectedFile || !datasetName.trim()) return;

    try {
      uploading = true;
      uploadProgress = 0;

      const formData = new FormData();
      formData.append("file", selectedFile);
      formData.append("name", datasetName.trim());
      formData.append("type", datasetType);

      const xhr = new XMLHttpRequest();

      xhr.upload.addEventListener("progress", (e) => {
        if (e.lengthComputable) {
          uploadProgress = (e.loaded / e.total) * 100;
        }
      });

      xhr.addEventListener("load", () => {
        if (xhr.status === 200) {
          showUploadModal = false;
          selectedFile = null;
          datasetName = "";
          uploadProgress = 0;
          loadDatasets();
        } else {
          error = "Upload failed: " + xhr.statusText;
        }
      });

      xhr.addEventListener("error", () => {
        error = "Upload failed: Network error";
      });

      xhr.open("POST", `${window.location.origin}/api/v1/datasets/upload`);
      xhr.send(formData);
    } catch (err) {
      error = err instanceof Error ? err.message : "Failed to upload dataset";
    } finally {
      uploading = false;
    }
  }

  async function deleteDataset(name: string) {
    if (!confirm(`Are you sure you want to delete dataset "${name}"?`)) {
      return;
    }

    try {
      await api.delete(`/datasets/${name}`);
      await loadDatasets();
    } catch (err) {
      error = err instanceof Error ? err.message : "Failed to delete dataset";
    }
  }

  async function previewDataset(dataset: Dataset) {
    try {
      loadingPreview = true;
      selectedDataset = dataset;
      const response = await api.get(
        `/datasets/${dataset.name}/preview?limit=10`,
      );
      previewData = response.samples || [];
    } catch (err) {
      error = err instanceof Error ? err.message : "Failed to load preview";
      previewData = [];
    } finally {
      loadingPreview = false;
    }
  }

  function formatFileSize(bytes: number): string {
    if (bytes === 0) return "0 B";
    const k = 1024;
    const sizes = ["B", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  function formatDate(dateString: string): string {
    if (!dateString) return "N/A";
    return new Date(dateString).toLocaleString();
  }

  function getFormatBadgeColor(format: string): "success" | "info" | "warning" {
    const formats: Record<string, "success" | "info" | "warning"> = {
      jsonl: "success",
      json: "success",
      csv: "info",
      parquet: "info",
      txt: "warning",
    };
    return formats[format] || "info";
  }

  async function loadDatasetFromHub(datasetId: string) {
    if (!confirm(`Load dataset "${datasetId}" from HuggingFace Hub?`)) {
      return;
    }

    try {
      loadingHubDataset = true;
      error = "";

      // Call API to load dataset from hub
      const response = await api.post("/datasets/from-hub", {
        dataset_id: datasetId,
        split: "train", // Default to train split
      });

      if (response.success) {
        // Switch to local tab and refresh
        activeTab = "local";
        await loadDatasets();
        selectedHubDataset = null;
      } else {
        error = response.message || "Failed to load dataset from Hub";
      }
    } catch (err) {
      error =
        err instanceof Error ? err.message : "Failed to load dataset from Hub";
    } finally {
      loadingHubDataset = false;
    }
  }

  onMount(() => {
    loadDatasets();
  });
</script>

<svelte:head>
  <title>Datasets - Model Garden</title>
</svelte:head>

<div class="min-h-screen bg-gray-50 pt-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Datasets</h1>
        <p class="mt-2 text-sm text-gray-600">
          Manage training datasets for fine-tuning models
        </p>
      </div>
      <div class="flex gap-3">
        <Button
          onclick={() => (activeTab = activeTab === "local" ? "hub" : "local")}
          variant="secondary"
        >
          {activeTab === "local" ? "🔍 Browse Hub" : "📁 My Datasets"}
        </Button>
        <Button onclick={() => (showUploadModal = true)} variant="primary">
          + Upload Dataset
        </Button>
      </div>
    </div>

    {#if error}
      <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-start">
          <span class="text-red-600 mr-2">⚠️</span>
          <div class="flex-1">
            <p class="text-sm text-red-800">{error}</p>
          </div>
          <button
            onclick={() => (error = "")}
            class="text-red-600 hover:text-red-800"
          >
            ✕
          </button>
        </div>
      </div>
    {/if}

    <!-- Tabs -->
    <div class="mb-6">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button
            onclick={() => (activeTab = "local")}
            class="border-b-2 py-4 px-1 text-sm font-medium transition-colors {activeTab ===
            'local'
              ? 'border-primary-500 text-primary-600'
              : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}"
          >
            📁 My Datasets ({datasets.length})
          </button>
          <button
            onclick={() => (activeTab = "hub")}
            class="border-b-2 py-4 px-1 text-sm font-medium transition-colors {activeTab ===
            'hub'
              ? 'border-primary-500 text-primary-600'
              : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}"
          >
            🤗 HuggingFace Hub
          </button>
        </nav>
      </div>
    </div>

    <!-- Local Datasets Tab -->
    {#if activeTab === "local"}
      {#if loading}
        <div class="flex justify-center items-center h-64">
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"
          ></div>
        </div>
      {:else if datasets.length === 0}
        <Card>
          <div class="text-center py-12">
            <div class="text-6xl mb-4">📊</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">
              No datasets yet
            </h3>
            <p class="text-gray-500 mb-6">
              Upload a dataset or browse the HuggingFace Hub
            </p>
            <div class="flex gap-3 justify-center">
              <Button
                onclick={() => (showUploadModal = true)}
                variant="primary"
              >
                Upload Dataset
              </Button>
              <Button onclick={() => (activeTab = "hub")} variant="secondary">
                Browse Hub
              </Button>
            </div>
          </div>
        </Card>
      {:else}
        <!-- Datasets Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {#each datasets as dataset}
            <Card class="hover:shadow-lg transition-shadow">
              <div class="p-6">
                <!-- Header -->
                <div class="flex justify-between items-start mb-4">
                  <div class="flex-1 min-w-0">
                    <h3
                      class="text-lg font-semibold text-gray-900 truncate mb-1"
                    >
                      {dataset.name}
                    </h3>
                    <Badge
                      variant={getFormatBadgeColor(dataset.format)}
                      size="sm"
                    >
                      {dataset.format.toUpperCase()}
                    </Badge>
                  </div>
                  <button
                    onclick={() => deleteDataset(dataset.name)}
                    class="text-gray-400 hover:text-red-600 transition-colors ml-2"
                    title="Delete dataset"
                  >
                    🗑️
                  </button>
                </div>

                <!-- Stats -->
                <div class="space-y-2 mb-4">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Examples:</span>
                    <span class="font-medium text-gray-900">
                      {dataset.examples.toLocaleString()}
                    </span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Size:</span>
                    <span class="font-medium text-gray-900">
                      {formatFileSize(dataset.size)}
                    </span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Created:</span>
                    <span
                      class="font-medium text-gray-900 truncate ml-2"
                      title={formatDate(dataset.created_at)}
                    >
                      {new Date(dataset.created_at).toLocaleDateString()}
                    </span>
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                  <Button
                    onclick={() => previewDataset(dataset)}
                    variant="secondary"
                    size="sm"
                    fullWidth
                  >
                    👁️ Preview
                  </Button>
                  <Button
                    href={`/training/new?dataset=${dataset.name}`}
                    variant="primary"
                    size="sm"
                    fullWidth
                  >
                    🎓 Train
                  </Button>
                </div>
              </div>
            </Card>
          {/each}
        </div>
      {/if}
    {/if}

    <!-- HuggingFace Hub Tab -->
    {#if activeTab === "hub"}
      <!-- Search and Filter -->
      <Card class="mb-6">
        <div class="p-4">
          <div class="flex flex-wrap gap-4">
            <!-- Search -->
            <div class="flex-1 min-w-[300px]">
              <input
                type="text"
                bind:value={hubSearchQuery}
                placeholder="Search datasets..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              />
            </div>

            <!-- Filter -->
            <div class="w-48">
              <select
                bind:value={hubFilter}
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
              >
                <option value="all">All Types</option>
                <option value="text">Text</option>
                <option value="vision">Vision</option>
                <option value="audio">Audio</option>
              </select>
            </div>
          </div>
        </div>
      </Card>

      <!-- Popular Datasets -->
      <div class="mb-4">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">
          Popular Instruction Datasets
        </h2>
      </div>

      {#if filteredHubDatasets.length === 0}
        <Card>
          <div class="text-center py-12">
            <div class="text-6xl mb-4">🔍</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">
              No datasets found
            </h3>
            <p class="text-gray-500">Try adjusting your search or filters</p>
          </div>
        </Card>
      {:else}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {#each filteredHubDatasets as dataset}
            <Card class="hover:shadow-lg transition-shadow">
              <div class="p-6">
                <!-- Header -->
                <div class="mb-4">
                  <div class="flex items-start justify-between mb-2">
                    <div class="flex-1 min-w-0">
                      <h3
                        class="text-lg font-semibold text-gray-900 mb-1 truncate"
                        title={dataset.id}
                      >
                        {dataset.datasetName}
                      </h3>
                      <p class="text-sm text-gray-600 truncate">
                        by <span class="font-medium">{dataset.author}</span>
                      </p>
                    </div>
                  </div>

                  {#if dataset.description}
                    <p class="text-sm text-gray-700 line-clamp-2 mb-3">
                      {dataset.description}
                    </p>
                  {/if}

                  <!-- Tags -->
                  <div class="flex flex-wrap gap-1 mb-3">
                    {#each dataset.tags.slice(0, 3) as tag}
                      <Badge variant="info" size="sm">
                        {tag}
                      </Badge>
                    {/each}
                  </div>
                </div>

                <!-- Stats -->
                <div
                  class="flex items-center gap-4 text-sm text-gray-600 mb-4 pb-4 border-b border-gray-200"
                >
                  <div class="flex items-center gap-1" title="Downloads">
                    <span>⬇️</span>
                    <span>{(dataset.downloads / 1000).toFixed(0)}k</span>
                  </div>
                  <div class="flex items-center gap-1" title="Likes">
                    <span>❤️</span>
                    <span>{dataset.likes}</span>
                  </div>
                  {#if dataset.size}
                    <div class="flex items-center gap-1" title="Size">
                      <span>📦</span>
                      <span>{dataset.size}</span>
                    </div>
                  {/if}
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                  <Button
                    onclick={() =>
                      window.open(
                        `https://huggingface.co/datasets/${dataset.id}`,
                        "_blank",
                      )}
                    variant="secondary"
                    size="sm"
                    fullWidth
                  >
                    🤗 View on Hub
                  </Button>
                  <Button
                    onclick={() => loadDatasetFromHub(dataset.id)}
                    variant="primary"
                    size="sm"
                    fullWidth
                    loading={loadingHubDataset}
                    disabled={loadingHubDataset}
                  >
                    💾 Load
                  </Button>
                </div>
              </div>
            </Card>
          {/each}
        </div>
      {/if}
    {/if}
  </div>
</div>

<!-- Upload Modal -->
{#if showUploadModal}
  <div
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
  >
    <Card class="max-w-2xl w-full">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Upload Dataset</h2>
          <button
            onclick={() => {
              showUploadModal = false;
              selectedFile = null;
              datasetName = "";
              uploadProgress = 0;
            }}
            class="text-gray-400 hover:text-gray-600"
            disabled={uploading}
          >
            ✕
          </button>
        </div>

        <div class="space-y-6">
          <!-- File Input -->
          <div>
            <label
              for="dataset-file"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Dataset File
            </label>
            <input
              type="file"
              id="dataset-file"
              bind:this={fileInput}
              onchange={handleFileSelect}
              accept=".json,.jsonl,.csv,.txt,.parquet"
              disabled={uploading}
              class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-lg file:border-0
                file:text-sm file:font-semibold
                file:bg-primary-50 file:text-primary-700
                hover:file:bg-primary-100
                disabled:opacity-50 disabled:cursor-not-allowed"
            />
            <p class="mt-2 text-xs text-gray-500">
              Supported formats: JSON, JSONL, CSV, TXT, Parquet
            </p>
          </div>

          <!-- Dataset Name -->
          <div>
            <label
              for="dataset-name"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Dataset Name
            </label>
            <input
              type="text"
              id="dataset-name"
              bind:value={datasetName}
              placeholder="my-dataset"
              disabled={uploading}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:bg-gray-100"
            />
          </div>

          <!-- Dataset Type -->
          <div>
            <label
              for="dataset-type"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Dataset Type
            </label>
            <select
              id="dataset-type"
              bind:value={datasetType}
              disabled={uploading}
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:bg-gray-100"
            >
              <option value="text">Text</option>
              <option value="vision">Vision</option>
              <option value="multimodal">Multimodal</option>
            </select>
          </div>

          <!-- Upload Progress -->
          {#if uploading}
            <div>
              <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span>Uploading...</span>
                <span>{Math.round(uploadProgress)}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div
                  class="bg-primary-600 h-2 rounded-full transition-all duration-300"
                  style="width: {uploadProgress}%"
                ></div>
              </div>
            </div>
          {/if}

          <!-- Actions -->
          <div class="flex gap-3 pt-4">
            <Button
              onclick={() => {
                showUploadModal = false;
                selectedFile = null;
                datasetName = "";
                uploadProgress = 0;
              }}
              variant="secondary"
              fullWidth
              disabled={uploading}
            >
              Cancel
            </Button>
            <Button
              onclick={uploadDataset}
              variant="primary"
              fullWidth
              disabled={!selectedFile || !datasetName.trim() || uploading}
              loading={uploading}
            >
              {uploading ? "Uploading..." : "Upload"}
            </Button>
          </div>
        </div>
      </div>
    </Card>
  </div>
{/if}

<!-- Preview Modal -->
{#if selectedDataset}
  <div
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
  >
    <Card class="max-w-4xl w-full max-h-[80vh] flex flex-col">
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-2xl font-bold text-gray-900">
              {selectedDataset.name}
            </h2>
            <p class="text-sm text-gray-600 mt-1">Showing first 10 samples</p>
          </div>
          <button
            onclick={() => {
              selectedDataset = null;
              previewData = [];
            }}
            class="text-gray-400 hover:text-gray-600"
          >
            ✕
          </button>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-6">
        {#if loadingPreview}
          <div class="flex justify-center items-center h-32">
            <div
              class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"
            ></div>
          </div>
        {:else if previewData.length === 0}
          <p class="text-center text-gray-500 py-8">No data to preview</p>
        {:else}
          <div class="space-y-4">
            {#each previewData as sample, index}
              <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <div class="text-xs font-medium text-gray-500 mb-2">
                  Sample {index + 1}
                </div>
                <pre
                  class="text-sm text-gray-900 whitespace-pre-wrap overflow-x-auto">{JSON.stringify(
                    sample,
                    null,
                    2,
                  )}</pre>
              </div>
            {/each}
          </div>
        {/if}
      </div>

      <div class="p-6 border-t border-gray-200">
        <Button
          onclick={() => {
            selectedDataset = null;
            previewData = [];
          }}
          variant="secondary"
          fullWidth
        >
          Close
        </Button>
      </div>
    </Card>
  </div>
{/if}
